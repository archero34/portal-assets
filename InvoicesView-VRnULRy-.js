import{d as X,i as Z,r as s,f as ee,w as ae,o as te,c as le,j as m,k as _,q as n,F as oe,z as se,b as ne,m as ie,v as re}from"./index-njxYMIA0.js";import{B as ue,_ as de,I as ce,T as ve}from"./transactionFormUseCases-DyXKRKVB.js";import{_ as me,m as pe,H as fe,U as be}from"./index-BPFpVZYo.js";import{P as ge}from"./PageView-BfH8tsmj.js";import{B as Ie}from"./BlueCollarDropDown-BW_XbvPt.js";import{d as ye}from"./index-CS5tPIud.js";import{B as he}from"./BlueCollarModal-BuahIIZF.js";import"./BlueCollarInput-Bbfj4CwT.js";import"./BlueCollarBadge-QXQIXcG4.js";const we={class:"d-flex justify-content-start gap-3 filter-wrapper",id:"filter"},xe={class:"form-group"},_e=n("label",{class:"bc-text-dark",for:"status"},"Status",-1),Me={class:"form-group"},Pe=n("label",{class:"bc-text-dark",for:"date"},"Date",-1),Fe={class:"pt-3 px-4 w-100 bg-white"},Ve={class:"container-fluid py-2",id:"invoice-item"},ke={class:"card"},Ce={class:"card-body"},De=n("span",{class:"bc-text bc-text-gray-800 bc-fs-16 bc-fw-600 text-center"}," This invoice has been paid in full. ",-1),Ue=n("span",{class:"bc-text bc-text-gray-500 text-center"}," Please contact support if you believe this is an error. ",-1),Re=X({__name:"InvoicesView",setup(Te){const N=se(),{getInvoiceById:Y,getInvoices:z,printInvoice:L}=new ce,{getUserPreference:R}=new be,{setAlert:b}=Z(),M=s(ye),i=s(!1),{getTransactionForm:$}=new ve,P=s([{text:"All",value:"all"},{text:"Open",value:"CustInvc:A"},{text:"Paid In Full",value:"CustInvc:B"}]),v=s(P.value[0]),V=s([]),k=s([]),C=s([]),j=window.innerHeight*.48,D=s(0),y=s({}),u=s(null),U=s(null),h=s(!1),g=s(!1),T=s(""),d=ee({subtotal:{text:"0.00",value:0},total:{text:"0.00",value:0},amountpaid:{text:"0.00",value:0}}),E=()=>{U.value.clearValue()},q=s([{text:"View",value:"view"},{text:"Print",value:"print"},{text:"Pay",value:"pay"}]),F=async({page:l,itemsPerPage:e,sortBy:t,filterBy:a})=>{var I,c;i.value=!0,v.value&&v.value.value!=="all"&&(a?a==null||a.push({key:"status",operator:"is",value:v.value.value}):a=[{key:"status",operator:"is",value:v.value.value}]),u.value&&(a=a?a.concat({key:"trandate",operator:"onorbefore",value:u.value}):[{key:"trandate",operator:"onorbefore",value:u.value}]);const{invoices:r,totalItems:w,errors:p}=await z(l,e,t,a);p.value.length>0&&p.value[0]!=="Invalid page range: fetch."?(console.error("Error loading invoices:",p.value),b(),i.value=!1):(k.value=((I=r.value)==null?void 0:I.length)>0?r.value[0].reduce((o,f)=>(f.id!=="internalid"&&o.push({title:f.label,key:f.id}),o),[]).concat({title:"Actions",key:"actions"}):[],C.value=(c=r.value)==null?void 0:c.map(o=>o.reduce((f,x)=>(x.id&&(f[x.id]=x.text??x.value),f),{})),D.value=w.value,i.value=!1)},B=(l,e)=>{switch(l.stopPropagation(),l.target.innerText){case"View":S(e.internalid);break;case"Print":J(e.internalid);break;case"Pay":H(e.internalid);break}},S=l=>{N.push({name:"invoiceDetail",params:{invoiceId:l}})},J=async l=>{i.value=!0;const{url:e,errors:t}=await L(l);if(t.value.length>0)console.error("Error Printing Invoice:",t.value),b();else{window.open(e,"_blank");const a=document.createElement("a");a.href=e,a.setAttribute("download",`Invoice_${l}.pdf`),document.body.appendChild(a),a.click(),document.body.removeChild(a)}i.value=!1},H=async l=>{var e,t,a,r,w,p;if(i.value=!0,!g.value){T.value=l;const I=await G();I.value.groups.push({label:"UI_INJECTED_FIELDS",visible:!1,fields:[{id:"subtotal",label:"Subtotal",visible:!1},{id:"total",label:"Total",visible:!1},{id:"amountpaid",label:"Amount Paid",visible:!1}]});const c=await K(l,I);d.amountpaid.text=((e=c.value.bodyFields.find(o=>o.id==="amountpaid"))==null?void 0:e.text)??"0.00",d.amountpaid.value=((t=c.value.bodyFields.find(o=>o.id==="amountpaid"))==null?void 0:t.value)??0,d.total.text=((a=c.value.bodyFields.find(o=>o.id==="total"))==null?void 0:a.text)??"0.00",d.total.value=((r=c.value.bodyFields.find(o=>o.id==="total"))==null?void 0:r.value)??0,d.subtotal.text=((w=c.value.bodyFields.find(o=>o.id==="subtotal"))==null?void 0:w.text)??"0.00",d.subtotal.value=((p=c.value.bodyFields.find(o=>o.id==="subtotal"))==null?void 0:p.value)??0}if(d.total.value===d.amountpaid.value){h.value=!h.value,i.value=!1;return}i.value=!1,await A(),g.value=!g.value},O=async()=>{var t;const{userPreference:l,errors:e}=await R();e.value.length>0?(console.error("Error loading user preference:",e.value),b()):(u.value&&(u.value=pe(u.value,y.value.dateFormat.replace(/d/g,"D").replace(/y/g,"Y")).format(l.value.dateFormat.replace(/Mon/g,"MMM").replace(/MONTH/g,"MMMM")||"DD/MM/YYYY")),y.value={...l.value,dateFormat:(t=l.value.dateFormat)==null?void 0:t.replace(/D/g,"d").replace(/Mon/g,"MMM").replace(/MONTH/g,"MMMM").replace(/Y/g,"y")})},G=async()=>{const{transactionForm:l,errors:e}=await $("INVOICE");if(e.value.length>0)console.error("Error loading invoice transaction form",e.value),b(),i.value=!1;else return l},K=async(l,e)=>{const{invoice:t,errors:a}=await Y(l,e.value);if(a.value.length>0)console.error("Error loading invoice",a.value),b(),i.value=!1;else return t},Q=(l,e)=>{var a;const t=(a=e==null?void 0:e.item)==null?void 0:a.internalid;t?S(t):console.warn("Internal Id not found in the row data:",e)},A=async()=>{await O(),await F({page:1,itemsPerPage:M.value})},W=async()=>{v.value=P.value[0],E()};return ae([v,u],()=>{F({page:1,itemsPerPage:M.value})}),te(async()=>{await O()}),(l,e)=>(ne(),le(oe,null,[m(ge,null,{icon:_(()=>[n("span",null,[m(de)])]),pagename:_(()=>[ie("Invoices")]),content:_(()=>{var t,a;return[n("div",we,[n("div",xe,[_e,m(Ie,{items:P.value,name:"status",id:"status",modelValue:v.value,"onUpdate:modelValue":e[0]||(e[0]=r=>v.value=r)},null,8,["items","modelValue"])]),n("div",Me,[Pe,m(re(fe),{id:"date",name:"date",placeholder:"Select Date",modelValue:u.value,"onUpdate:modelValue":e[1]||(e[1]=r=>u.value=r),format:((t=y.value)==null?void 0:t.dateFormat)||"dd/MM/yyyy","model-type":((a=y.value)==null?void 0:a.dateFormat)||"dd/MM/yyyy",onClear:e[2]||(e[2]=r=>E()),"enable-time-picker":!1,ref_key:"datePicker",ref:U},null,8,["modelValue","format","model-type"])])])]}),_:1}),n("div",Fe,[n("section",Ve,[n("div",ke,[n("div",Ce,[m(me,{tableHeaders:k.value,tableItems:C.value,loading:i.value,itemsLength:D.value,selectedItems:V.value,pageSize:M.value,tableHeight:j,optionItems:q.value,onRefreshTable:A,onClearFilters:W,onUpdateOptions:F,"onUpdate:selectedItems":e[3]||(e[3]=t=>V.value=t),onRowClick:Q,onViewItem:B},null,8,["tableHeaders","tableItems","loading","itemsLength","selectedItems","pageSize","optionItems"])])])])]),m(ue,{modelValue:g.value,"onUpdate:modelValue":e[4]||(e[4]=t=>g.value=t),amountDetails:d,onOnClose:H,invoiceId:T.value},null,8,["modelValue","amountDetails","invoiceId"]),m(he,{modelValue:h.value,"onUpdate:modelValue":e[5]||(e[5]=t=>h.value=t)},{content:_(()=>[De,Ue]),_:1},8,["modelValue"])],64))}});export{Re as default};
